<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© - 20 Ø³Ø¤Ø§Ù„Ø§Ù‹</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; color: #2c3e50; }
    .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
    header { background: linear-gradient(to right, #2c3e50, #4a6491); color: white; padding: 25px; text-align: center; }
    h1 { font-size: 2.1rem; margin-bottom: 8px; font-weight: 700; }
    .subtitle { font-size: 1rem; opacity: 0.9; }
    .main-content { display: grid; grid-template-columns: 1.1fr 0.9fr; gap: 20px; padding: 24px; }
    @media (max-width: 1024px){ .main-content{ grid-template-columns: 1fr; } }
    .section { background: #f8f9fa; border-radius: 15px; padding: 18px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .section-title { color: #2c3e50; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid #3498db; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
    .edit-btn { background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .upload-area { border: 3px dashed #3498db; border-radius: 10px; padding: 24px 14px; text-align: center; cursor: pointer; transition: all 0.3s; background: #e8f4fc; margin-bottom: 12px; }
    .upload-area:hover { background: #d6eaf8; border-color: #2980b9; }
    .camera-btn { background: linear-gradient(to right, #3498db, #2980b9); color: white; border: none; padding: 10px 18px; border-radius: 999px; font-size: 0.95rem; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .advanced-controls { background: #fff8e1; border: 2px solid #ffb300; border-radius: 10px; padding: 12px; margin: 12px 0; }
    .control-row { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
    .control-item { display: flex; flex-direction: column; gap: 6px; }
    .control-label { font-size: 0.9rem; color: #5d4037; font-weight: 600; }
    .advanced-slider { width: 100%; height: 8px; -webkit-appearance: none; appearance: none; background: #e0e0e0; border-radius: 4px; }
    .advanced-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: #3498db; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .value-display { display: flex; justify-content: space-between; font-size: 0.8rem; color: #666; }
    .calibration-btn { background: #9b59b6; color: white; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; width: 100%; margin-top: 6px; }
    .calibration-btn.active { background: #8e44ad; box-shadow: 0 0 10px rgba(155, 89, 182, 0.5); }
    .image-controls { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 12px 0; }
    .control-group { display: flex; gap: 8px; flex-wrap: wrap; }
    .control-btn { padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
    .rotate-btn { background: #9b59b6; color: white; }
    .auto-rotate-btn { background: #f39c12; color: white; }
    .correct-btn { background: #2ecc71; color: white; }
    .scan-btn { background: #e74c3c; color: white; }
    .reset-btn { background: #95a5a6; color: white; }
    .manual-btn { background: #3498db; color: white; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    .canvas-container { border: 2px solid #ddd; border-radius: 10px; overflow: hidden; margin: 12px 0; background: white; position: relative; }
    canvas { display: block; max-width: 100%; cursor: crosshair; }
    .canvas-overlay { position: absolute; inset: 0; pointer-events: none; }
    .detection-point { position: absolute; width: 12px; height: 12px; border-radius: 50%; border: 2px solid #e74c3c; background: rgba(231, 76, 60, 0.3); transform: translate(-50%, -50%); }
    .detection-label { position: absolute; background: rgba(0,0,0,0.7); color: white; padding: 2px 6px; border-radius: 3px; font-size: 0.75rem; transform: translate(-50%, -150%); white-space: nowrap; }
    .orientation-indicator { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.85rem; z-index: 10; }
    .calibration-guide { position: absolute; top: 44px; left: 10px; background: rgba(52, 152, 219, 0.95); color: white; padding: 10px; border-radius: 5px; font-size: 0.85rem; max-width: 300px; z-index: 10; }
    .hidden { display: none !important; }
    .loading { display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; margin: 10px auto; }
    @keyframes spin { 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
    .instructions { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 10px; padding: 10px; margin-top: 10px; font-size: 0.85rem; }
    .answer-order-diagram { background: #f0f7ff; border: 2px solid #3498db; border-radius: 10px; padding: 12px; margin-top: 10px; text-align: center; }
    .order-example { display: flex; justify-content: center; align-items: center; gap: 16px; margin-top: 8px; }
    .bubble { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; }
    .bubble.a { background: #e74c3c; } .bubble.b { background: #3498db; } .bubble.c { background: #2ecc71; } .bubble.d { background: #f39c12; }
    .results { background: #e8f6f3; border-radius: 10px; padding: 16px; margin-top: 12px; }
    .score { font-size: 1.6rem; font-weight: 700; color: #27ae60; text-align: center; margin: 10px 0; }
    .progress-bar { height: 14px; background: #ecf0f1; border-radius: 8px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: linear-gradient(to right, #2ecc71, #27ae60); transition: width 0.5s ease; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; text-align: center; }
    .stat-item { background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
    .stat-value { font-size: 1.25rem; font-weight: 700; color: #2c3e50; }
    .stat-label { color: #7f8c8d; font-size: 0.8rem; }
    .results-details { max-height: 240px; overflow-y: auto; margin-top: 10px; padding: 10px; background: white; border-radius: 8px; border: 1px solid #ddd; }
    .detail-item { padding: 8px; margin: 5px 0; border-radius: 6px; border-right: 4px solid #ddd; font-size: 0.92rem; }
    .detail-item.correct { background: #d5f4e6; border-right-color: #2ecc71; }
    .detail-item.wrong { background: #fadbd8; border-right-color: #e74c3c; }
    .detail-item.empty { background: #f8f9fa; border-right-color: #95a5a6; }
    .detail-item.unclear { background: #fef9e7; border-right-color: #f39c12; }
    .answer-key { background: #fffde7; border: 2px solid #f1c40f; border-radius: 10px; padding: 14px; margin-top: 10px; }
    .key-title { color: #f39c12; font-weight: 700; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
    .questions-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .question-item { background: white; border: 2px solid #ddd; border-radius: 6px; padding: 8px; text-align: center; transition: all 0.3s; font-size: 0.9rem; }
    .question-item.correct { border-color: #2ecc71; background: #d5f4e6; }
    .question-item.wrong { border-color: #e74c3c; background: #fadbd8; }
    .question-item.empty { border-color: #95a5a6; background: #f8f9fa; }
    .question-item.unclear { border-color: #f39c12; background: #fef9e7; }
    .question-number { font-weight: 700; color: #2c3e50; font-size: 0.8rem; }
    .question-answer { font-size: 1.1rem; margin-top: 2px; font-weight: bold; min-height: 24px; }
    .debug-panel { background: #2c3e50; color: white; padding: 12px; border-radius: 10px; margin-top: 10px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.8rem; }
    .debug-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .debug-toggle { background: #3498db; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 0.8rem; }

    /* Modal (Edit answers) */
    .camera-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: grid; place-items: center; z-index: 1000; }
    .edit-container { background: white; width: min(900px, 92vw); border-radius: 12px; padding: 14px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .edit-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .edit-title { font-weight: 700; color: #2c3e50; }
    .close-edit-btn { background: #e74c3c; color: white; border: none; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .quick-actions { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
    .quick-action-btn { background: #f0f7ff; border: 1px solid #3498db; color: #3498db; padding: 6px 10px; border-radius: 6px; cursor: pointer; }
    .edit-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .edit-question { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 8px; }
    .edit-question-number { font-size: 0.9rem; font-weight: 700; margin-bottom: 6px; }
    .answer-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .answer-option { border: 2px solid #ddd; border-radius: 6px; padding: 6px; text-align: center; cursor: pointer; font-weight: 700; }
    .answer-option.selected { border-color: #3498db; background: #ebf5fb; }
    .bulk-edit { margin-top: 12px; }
    .bulk-edit-title { font-weight: 700; margin-bottom: 6px; }
    .bulk-edit-textarea { width: 100%; min-height: 140px; border: 1px solid #ddd; border-radius: 8px; padding: 8px; font-family: inherit; }
    .bulk-edit-example { font-size: 0.85rem; color: #7f8c8d; margin-top: 6px; }
    .edit-controls { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; }
    .save-btn { background: #2ecc71; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }
    .cancel-btn { background: #95a5a6; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; }

    /* Manual correction panel */
    .manual-correction { background: #e8f4fc; border: 2px solid #3498db; border-radius: 10px; padding: 12px; margin-top: 10px; }
    .manual-title { color: #2980b9; font-weight: 700; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
    .correction-controls { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
    .correction-btn { background: #34495e; color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“± Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø°ÙƒÙŠ Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© - 20 Ø³Ø¤Ø§Ù„Ø§Ù‹</h1>
      <div class="subtitle">ØªØµØ­ÙŠØ­ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù†Ù…Ø§Ø°Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª | Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ† (10 + 10)</div>
    </header>

    <div class="main-content">
      <!-- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© -->
      <div class="section">
        <h2 class="section-title">ğŸ“¸ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©</h2>
        <div class="upload-area" id="uploadArea">
          <div style="font-size: 2rem;">ğŸ“</div>
          <h3>Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª ØµÙˆØ±Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‡Ù†Ø§</h3>
          <p>Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ø§Ø®ØªÙŠØ§Ø± ØµÙˆØ±Ø©</p>
          <input type="file" id="imageInput" accept="image/*" class="hidden"/>
        </div>

        <button class="camera-btn" id="cameraBtn">ğŸ“· Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù‡Ø§ØªÙ</button>

        <div class="instructions">
          <strong>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªØµÙˆÙŠØ±:</strong>
          <ol style="padding-right: 18px; margin-top: 6px;">
            <li>Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠÙ…Ù„Ø£ Ù…Ø¹Ø¸Ù… Ø¥Ø·Ø§Ø± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</li>
            <li>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¶Ø§Ø¡Ø© Ø¬ÙŠØ¯Ø© ÙˆØªØ¬Ù†Ø¨ Ø§Ù„Ø¸Ù„Ø§Ù„</li>
            <li>Ø§Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ÙˆØ§Ø²ÙŠØ© Ù„Ù„Ù†Ù…ÙˆØ°Ø¬ Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†</li>
            <li>ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¯ÙˆÙŠØ± Ø§Ù„ØµÙˆØ±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØµÙˆÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù‚Ù„ÙˆØ¨Ø©</li>
          </ol>
        </div>

        <div class="answer-order-diagram">
          <strong>ØªØ±ØªÙŠØ¨ Ø¯ÙˆØ§Ø¦Ø± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©:</strong>
          <div class="order-example">
            <div class="bubble a">Ø£</div>
            <div class="bubble b">Ø¨</div>
            <div class="bubble c">Ø¬</div>
            <div class="bubble d">Ø¯</div>
            <span>â† Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±</span>
          </div>
        </div>

        <div class="advanced-controls">
          <div class="control-row">
            <div class="control-item">
              <div class="control-label">Ø¹ØªØ¨Ø© Ø§Ù„Ø³Ø·ÙˆØ¹</div>
              <input type="range" min="0" max="255" value="120" class="advanced-slider" id="brightnessThreshold"/>
              <div class="value-display"><span>Ø¯Ø§ÙƒÙ†</span><span id="brightnessValue">120</span><span>ÙØ§ØªØ­</span></div>
            </div>
            <div class="control-item">
              <div class="control-label">Ø­Ø¬Ù… Ù…Ù†Ø·Ù‚Ø© Ø§Ù„ÙƒØ´Ù</div>
              <input type="range" min="3" max="18" value="9" class="advanced-slider" id="detectionRadius"/>
              <div class="value-display"><span>ØµØºÙŠØ±</span><span id="radiusValue">9px</span><span>ÙƒØ¨ÙŠØ±</span></div>
            </div>
          </div>
          <div class="control-row">
            <div class="control-item">
              <div class="control-label">Ø¹ØªØ¨Ø© Ø§Ù„ØªØ¨Ø§ÙŠÙ†</div>
              <input type="range" min="1" max="3" step="0.1" value="1.6" class="advanced-slider" id="contrastThreshold"/>
              <div class="value-display"><span>Ù…Ù†Ø®ÙØ¶</span><span id="contrastValue">1.6</span><span>Ø¹Ø§Ù„ÙŠ</span></div>
            </div>
            <div class="control-item">
              <div class="control-label">ØªØ­Ø³Ø³ Ø§Ù„Ø­Ø¯ÙˆØ¯</div>
              <input type="range" min="0" max="20" value="10" class="advanced-slider" id="edgeSensitivity"/>
              <div class="value-display"><span>Ø®Ø´Ù†</span><span id="edgeValue">10</span><span>Ø¯Ù‚ÙŠÙ‚</span></div>
            </div>
          </div>
          <button class="calibration-btn" id="calibrationBtn">ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©</button>
        </div>

        <div class="image-controls">
          <div class="control-group">
            <button class="control-btn rotate-btn" id="rotateLeft">â†¶ ØªØ¯ÙˆÙŠØ± ÙŠØ³Ø§Ø±</button>
            <button class="control-btn rotate-btn" id="rotateRight">â†· ØªØ¯ÙˆÙŠØ± ÙŠÙ…ÙŠÙ†</button>
          </div>
          <div class="control-group">
            <button class="control-btn auto-rotate-btn" id="autoRotate">ğŸ”„ ØªØ¯ÙˆÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠ</button>
            <button class="control-btn correct-btn" id="correctPerspective">ğŸ”§ ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø©</button>
          </div>
        </div>

        <div class="controls">
          <button class="control-btn scan-btn" id="scanAnswers">ğŸ” Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª</button>
          <button class="control-btn manual-btn" id="manualCorrectionBtn">âœï¸ ØªØµØ­ÙŠØ­ ÙŠØ¯ÙˆÙŠ</button>
          <button class="control-btn reset-btn" id="resetBtn">â†» Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>

        <div class="canvas-container">
          <div class="orientation-indicator" id="orientationIndicator">Ø§Ù„Ø§ØªØ¬Ø§Ù‡: Ø·Ø¨ÙŠØ¹ÙŠ</div>
          <div id="calibrationGuide" class="calibration-guide hidden">
            <strong>ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©:</strong><br/>
            1) Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ² Ø¯Ø§Ø¦Ø±Ø© Ø®ÙŠØ§Ø± "Ø£" Ù„Ù„Ø³Ø¤Ø§Ù„ 1 ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„<br/>
            2) Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ù…Ø±ÙƒØ² Ø¯Ø§Ø¦Ø±Ø© Ø®ÙŠØ§Ø± "Ø£" Ù„Ù„Ø³Ø¤Ø§Ù„ 10 ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„<br/>
            Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø´Ø¨ÙƒØ© Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ù„Ø¹Ù…ÙˆØ¯ÙŠÙ†.
          </div>
          <canvas id="mainCanvas"></canvas>
          <div class="canvas-overlay" id="canvasOverlay"></div>
        </div>

        <div id="loading" class="hidden">
          <div class="loading"></div>
          <p style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø©...</p>
        </div>

        <div class="debug-panel hidden" id="debugPanel">
          <div class="debug-header">
            <span>ğŸ› Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØµØ­ÙŠØ­</span>
            <button class="debug-toggle" id="toggleDebug">Ø¥Ø®ÙØ§Ø¡</button>
          </div>
          <div class="debug-content" id="debugContent"></div>
        </div>
      </div>

      <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª -->
      <div class="section">
        <h2 class="section-title">
          <span>ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</span>
          <button class="edit-btn" id="editAnswersBtn">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬</button>
        </h2>

        <div class="answer-key">
          <div class="key-title"><span>ğŸ—ï¸</span> Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© (20 Ø³Ø¤Ø§Ù„Ø§Ù‹)</div>
          <div class="questions-grid" id="answerKey"></div>
        </div>

        <div class="manual-correction hidden" id="manualCorrection">
          <div class="manual-title"><span>âœï¸</span> Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙŠØ¯ÙˆÙŠ</div>
          <div id="correctionList"></div>
          <div class="correction-controls">
            <button class="correction-btn" id="saveCorrections">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª</button>
            <button class="correction-btn" id="cancelCorrections">âŒ Ø¥Ù„ØºØ§Ø¡</button>
          </div>
        </div>

        <div class="results">
          <h3 class="section-title" style="border-bottom:0;">ğŸ“ˆ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</h3>
          <div class="score" id="finalScore">0%</div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill" style="width:0%"></div></div>
          <div class="stats">
            <div class="stat-item"><div class="stat-value" id="correctCount">0</div><div class="stat-label">ØµØ­ÙŠØ­Ø©</div></div>
            <div class="stat-item"><div class="stat-value" id="wrongCount">0</div><div class="stat-label">Ø®Ø§Ø·Ø¦Ø©</div></div>
            <div class="stat-item"><div class="stat-value" id="emptyCount">0</div><div class="stat-label">ÙØ§Ø±ØºØ©</div></div>
            <div class="stat-item"><div class="stat-value" id="unclearCount">0</div><div class="stat-label">ØºÙŠØ± ÙˆØ§Ø¶Ø­Ø©</div></div>
          </div>
          <div class="results-details" id="resultsDetails"></div>
          <div class="answer-order-diagram" style="margin-top:10px;">
            <strong>ØªØ°ÙƒÙŠØ±:</strong> Ø®ÙŠØ§Ø±Ø§Øª ÙƒÙ„ Ø³Ø¤Ø§Ù„ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø±: Ø£ â†’ Ø¨ â†’ Ø¬ â†’ Ø¯
          </div>
          <div class="test-results" id="testResults" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Answers Modal -->
  <div id="editModal" class="camera-modal hidden">
    <div class="edit-container">
      <div class="edit-header">
        <div class="edit-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©</div>
        <button class="close-edit-btn" id="closeEditBtn">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
      </div>

      <div class="quick-actions">
        <button class="quick-action-btn" id="setAllA">ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ "Ø£"</button>
        <button class="quick-action-btn" id="setAllB">ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ "Ø¨"</button>
        <button class="quick-action-btn" id="setAllC">ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ "Ø¬"</button>
        <button class="quick-action-btn" id="setAllD">ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒÙ„ Ø¥Ù„Ù‰ "Ø¯"</button>
        <button class="quick-action-btn" id="clearAll">Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <div class="edit-grid" id="editGrid"></div>

      <div class="bulk-edit">
        <div class="bulk-edit-title">Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</div>
        <textarea class="bulk-edit-textarea" id="bulkEditTextarea" placeholder="Ø£Ø¯Ø®Ù„ 20 Ø³Ø·Ø±Ø§Ù‹ (Ø£/Ø¨/Ø¬/Ø¯)"></textarea>
        <button class="save-btn" id="applyBulkEdit">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹</button>
        <div class="bulk-edit-example">Ù…Ø«Ø§Ù„: Ø£Ø¯Ø®Ù„ 20 Ø³Ø·Ø±Ø§Ù‹ØŒ ÙƒÙ„ Ø³Ø·Ø± ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ (Ø£ØŒ Ø¨ØŒ Ø¬ØŒ Ø¯)</div>
      </div>

      <div class="edit-controls">
        <button class="save-btn" id="saveEditBtn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button class="cancel-btn" id="cancelEditBtn">âŒ Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <script>
    // ========= Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© =========
    let originalImage = null;
    let processedImage = null;
    const canvas = document.getElementById('mainCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    let isProcessing = false;
    let currentRotation = 0;
    let calibrationMode = false;
    let calibrationPoints = []; // Ù†Ù‚Ø·ØªØ§Ù†: (Ø³1-Ø£) Ùˆ (Ø³10-Ø£)
    let isManualCorrection = false;

    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ´Ù
    const detectionSettings = {
      brightnessThreshold: 120,
      detectionRadius: 9,
      contrastFactor: 1.6,
      edgeSensitivity: 10,
      minConfidence: 0.35,
      multiMarkTolerance: 0.12 // ÙŠØ³Ù…Ø­ Ø¨Ø§Ø¹ØªØ¨Ø§Ø± Ø§Ù„Ø³Ø¤Ø§Ù„ ØºÙŠØ± ÙˆØ§Ø¶Ø­ Ø¥Ø°Ø§ ØªÙ‚Ø§Ø±Ø¨Øª Ù†Ø³Ø¨ Ø§Ù„ØªØ¸Ù„ÙŠÙ„
    };

    // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
    let correctAnswers = JSON.parse(localStorage.getItem('correctAnswers')) || {
      1:'Ø£',2:'Ø¨',3:'Ø¬',4:'Ø¯',5:'Ø£',
      6:'Ø¨',7:'Ø¬',8:'Ø¯',9:'Ø£',10:'Ø¨',
      11:'Ø¬',12:'Ø¯',13:'Ø£',14:'Ø¨',15:'Ø¬',
      16:'Ø¯',17:'Ø£',18:'Ø¨',19:'Ø¬',20:'Ø¯'
    };

    // Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©
    let manualCorrections = JSON.parse(localStorage.getItem('manualCorrections') || '{}');

    // Ø´Ø¨ÙƒØ© Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø© (Ù†Ø³Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø­Ø¬Ù… Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³)
    let questionCoordinates = {};

    // ========= Ø§Ù„ØªÙ‡ÙŠØ¦Ø© =========
    document.addEventListener('DOMContentLoaded', initApp);
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (calibrationMode) toggleCalibrationMode();
        if (isManualCorrection) toggleManualCorrection();
        const editModal = document.getElementById('editModal');
        if (!editModal.classList.contains('hidden')) closeEditModal();
      }
    });

    function initApp(){
      setupEventListeners();
      generateAnswerKeyDisplay();
      updateOrientationIndicator();
      loadCalibrationSettings();
      // ØªØ­Ø¬ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ÙƒØ§Ù†ÙØ§Ø³
      canvas.width = 900; canvas.height = 1200;
    }

    // ========= Ù…Ø³ØªÙ…Ø¹Ùˆ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« =========
    function setupEventListeners(){
      document.getElementById('uploadArea').addEventListener('click',()=>document.getElementById('imageInput').click());
      document.getElementById('imageInput').addEventListener('change', handleImageUpload);

      const uploadArea = document.getElementById('uploadArea');
      uploadArea.addEventListener('dragover', e=>{ e.preventDefault(); uploadArea.style.backgroundColor='#d6eaf8'; });
      uploadArea.addEventListener('dragleave', ()=> uploadArea.style.backgroundColor='#e8f4fc' );
      uploadArea.addEventListener('drop', e=>{
        e.preventDefault(); uploadArea.style.backgroundColor='#e8f4fc';
        if (e.dataTransfer.files.length){
          const file = e.dataTransfer.files[0];
          if (file.type.startsWith('image/')) handleImageUpload({target:{files:[file]}})
        }
      });

      document.getElementById('rotateLeft').addEventListener('click', ()=> rotateImage(-90));
      document.getElementById('rotateRight').addEventListener('click', ()=> rotateImage(90));
      document.getElementById('autoRotate').addEventListener('click', autoRotateImage);
      document.getElementById('correctPerspective').addEventListener('click', enhanceImage);
      document.getElementById('scanAnswers').addEventListener('click', scanAnswers);
      document.getElementById('manualCorrectionBtn').addEventListener('click', toggleManualCorrection);
      document.getElementById('resetBtn').addEventListener('click', resetApp);
      document.getElementById('calibrationBtn').addEventListener('click', toggleCalibrationMode);

      document.getElementById('brightnessThreshold').addEventListener('input', updateDetectionSettings);
      document.getElementById('detectionRadius').addEventListener('input', updateDetectionSettings);
      document.getElementById('contrastThreshold').addEventListener('input', updateDetectionSettings);
      document.getElementById('edgeSensitivity').addEventListener('input', updateDetectionSettings);

      document.getElementById('editAnswersBtn').addEventListener('click', openEditModal);
      document.getElementById('closeEditBtn').addEventListener('click', closeEditModal);
      document.getElementById('saveEditBtn').addEventListener('click', saveEdits);
      document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);

      document.getElementById('setAllA').addEventListener('click', ()=> setAllAnswers('Ø£'));
      document.getElementById('setAllB').addEventListener('click', ()=> setAllAnswers('Ø¨'));
      document.getElementById('setAllC').addEventListener('click', ()=> setAllAnswers('Ø¬'));
      document.getElementById('setAllD').addEventListener('click', ()=> setAllAnswers('Ø¯'));
      document.getElementById('clearAll').addEventListener('click', clearAllAnswers);
      document.getElementById('applyBulkEdit').addEventListener('click', applyBulkEdit);

      document.getElementById('saveCorrections').addEventListener('click', saveManualCorrections);
      document.getElementById('cancelCorrections').addEventListener('click', cancelManualCorrections);
      document.getElementById('toggleDebug').addEventListener('click', toggleDebugPanel);

      canvas.addEventListener('click', handleCanvasClick);
    }

    // ========= Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© =========
    function handleImageUpload(event){
      const file = event.target.files[0];
      if (!file) return;
      showLoading(true);
      const reader = new FileReader();
      reader.onload = e => loadImage(e.target.result);
      reader.readAsDataURL(file);
    }

    function loadImage(src){
      const img = new Image();
      img.onload = function(){
        originalImage = img;
        // Ø§Ø¶Ø¨Ø· Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„ØµÙˆØ±Ø©
        const maxW = 1000, maxH = 1400;
        const scale = Math.min(maxW / img.width, maxH / img.height, 1);
        canvas.width = Math.round(img.width * scale);
        canvas.height = Math.round(img.height * scale);
        drawImageWithRotation();
        processedImage = ctx.getImageData(0,0,canvas.width,canvas.height);
        showLoading(false);
        showDebugInfo(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©: ${canvas.width}x${canvas.height}`);
        if (calibrationMode) showCalibrationGuide();
      };
      img.onerror = function(){ showLoading(false); alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©.'); };
      img.src = src;
    }

    // ========= ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© =========
    function enhanceImage(){
      if (!originalImage){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      showLoading(true);
      setTimeout(()=>{
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const data = imageData.data;
        // Ø¥Ù„Ù‰ Ø±Ù…Ø§Ø¯ÙŠ + ØªØ¨Ø§ÙŠÙ†
        for (let i=0;i<data.length;i+=4){
          const r=data[i], g=data[i+1], b=data[i+2];
          const gray = 0.299*r + 0.587*g + 0.114*b;
          const adj = ((gray - 128)*detectionSettings.contrastFactor)+128;
          const val = Math.min(255, Math.max(0, adj));
          data[i]=data[i+1]=data[i+2]=val;
        }
        // Ø¥Ø¨Ø±Ø§Ø² Ø§Ù„Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ø³ÙŠØ· (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ©)
        if (detectionSettings.edgeSensitivity>0){
          applyEdgeEnhancement(data);
        }
        ctx.putImageData(imageData,0,0);
        processedImage = imageData;
        showLoading(false);
        showDebugInfo('ØªÙ… ØªØ­Ø³ÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­');
      }, 300);
    }

    function applyEdgeEnhancement(data){
      const w=canvas.width, h=canvas.height;
      const temp = new Uint8ClampedArray(data);
      const kernel = [
        [-1,-1,-1],
        [-1, 9,-1],
        [-1,-1,-1]
      ];
      for (let y=1;y<h-1;y++){
        for (let x=1;x<w-1;x++){
          let sum=0;
          for (let ky=-1;ky<=1;ky++){
            for (let kx=-1;kx<=1;kx++){
              const idx = ((y+ky)*w+(x+kx))*4;
              sum += temp[idx]*kernel[ky+1][kx+1];
            }
          }
          const idx = (y*w+x)*4;
          const v = Math.min(255, Math.max(0, sum));
          data[idx]=data[idx+1]=data[idx+2]=v;
        }
      }
    }

    // ========= Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© =========
    function toggleCalibrationMode(){
      calibrationMode = !calibrationMode;
      const btn = document.getElementById('calibrationBtn');
      if (calibrationMode){
        btn.classList.add('active');
        btn.textContent = 'ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© (Ù†Ø´Ø·)';
        showCalibrationGuide();
        clearCalibrationPoints();
        showDebugInfo('Ø§Ù†Ù‚Ø± Ù†Ù‚Ø·ØªÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©: Ø³1-Ø£ Ø«Ù… Ø³10-Ø£ ÙÙŠ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„.');
      } else {
        btn.classList.remove('active');
        btn.textContent = 'ğŸ¯ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©';
        hideCalibrationGuide();
        hideCalibrationPoints();
        showDebugInfo('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©.');
      }
    }

    function showCalibrationGuide(){ document.getElementById('calibrationGuide').classList.remove('hidden'); }
    function hideCalibrationGuide(){ document.getElementById('calibrationGuide').classList.add('hidden'); }

    function handleCanvasClick(event){
      if (!calibrationMode || !processedImage) return;
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      calibrationPoints.push({x, y});
      drawCalibrationMarker(x, y, calibrationPoints.length);
      showDebugInfo(`Ù†Ù‚Ø·Ø© Ù…Ø¹Ø§ÙŠØ±Ø© ${calibrationPoints.length} Ø¹Ù†Ø¯ (${Math.round(x)}, ${Math.round(y)})`);
      if (calibrationPoints.length === 2){
        buildCoordinatesFromCalibration();
        toggleCalibrationMode();
      }
    }

    function drawCalibrationMarker(x,y,index){
      const overlay = document.getElementById('canvasOverlay');
      const p = document.createElement('div');
      p.className = 'detection-point';
      p.style.left = x+'px'; p.style.top = y+'px';
      const label = document.createElement('div');
      label.className = 'detection-label';
      label.textContent = `Ù†Ù‚Ø·Ø© ${index}`;
      label.style.left = x+'px'; label.style.top = y+'px';
      overlay.appendChild(p); overlay.appendChild(label);
    }

    function clearCalibrationPoints(){ calibrationPoints = []; document.getElementById('canvasOverlay').innerHTML=''; }
    function hideCalibrationPoints(){ document.getElementById('canvasOverlay').innerHTML=''; }

    // Ù†Ø¨Ù†ÙŠ Ø´Ø¨ÙƒØ©: Ø¹Ù…ÙˆØ¯Ø§Ù†ØŒ 10 ØµÙÙˆÙ. Ø§Ù„Ù†Ù‚Ø·Ø©1 = Ø³1-Ø£ØŒ Ø§Ù„Ù†Ù‚Ø·Ø©2 = Ø³10-Ø£
    function buildCoordinatesFromCalibration(){
      if (calibrationPoints.length<2) return;
      const p1 = calibrationPoints[0]; // Ø³Ø¤Ø§Ù„1-Ø£ (ÙŠÙ…ÙŠÙ† Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„)
      const p10 = calibrationPoints[1]; // Ø³Ø¤Ø§Ù„10-Ø£ (ÙŠÙ…ÙŠÙ† Ø§Ù„ØµÙ Ø§Ù„Ø¹Ø§Ø´Ø±)

      // Ø§ØªÙ‘Ø¬Ø§Ù‡ Ø§Ù„Ø¹Ù…ÙˆØ¯: Ù…Ù† p1 Ø¥Ù„Ù‰ p10
      const dxCol = (p10.x - p1.x)/9;
      const dyCol = (p10.y - p1.y)/9;

      // Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª Ø£â†’Ø¨â†’Ø¬â†’Ø¯ Ù…Ù† Ø§Ù„ÙŠÙ…ÙŠÙ† Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± (Ø§ÙØªØ±Ø§Ø¶ Ù…Ø³Ø§ÙØ© Ø«Ø§Ø¨ØªØ© Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„)
      // ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø­Ø³Ø¨ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ø¯ÙŠÙƒ
      const optionStepPx = 42; // Ø¬Ø±Ù‘Ø¨ 36-50 Ø­Ø³Ø¨ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
      // Ø¹Ù…ÙˆØ¯ Ø«Ø§Ù†Ù Ø¥Ù„Ù‰ Ø§Ù„ÙŠØ³Ø§Ø± (Ø£Ùˆ ÙŠÙ…ÙŠÙ†) Ø¨Ù…Ø³Ø§ÙØ© Ø£ÙÙ‚ÙŠØ© ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
      const columnOffsetPx = 430; // Ø¹Ø¯Ù‘Ù„ ÙˆÙÙ‚ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø¹Ù…ÙˆØ¯ÙÙŠ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©)

      // Ù†Ø¨Ù†ÙŠ 20 Ø³Ø¤Ø§Ù„Ø§Ù‹ Ã— 4 Ø®ÙŠØ§Ø±Ø§Øª
      questionCoordinates = {};
      for (let row=0; row<10; row++){
        // Ø¹Ù…ÙˆØ¯ 1 (Ø£Ø³Ø¦Ù„Ø© 1-10)
        const baseX1 = p1.x + dxCol*row;
        const baseY1 = p1.y + dyCol*row;
        const qNum1 = 1 + row;

        questionCoordinates[qNum1] = {
          base: toNorm(baseX1, baseY1),
          options: {
            'Ø£': toNorm(baseX1, baseY1),
            'Ø¨': toNorm(baseX1 - optionStepPx, baseY1),
            'Ø¬': toNorm(baseX1 - optionStepPx*2, baseY1),
            'Ø¯': toNorm(baseX1 - optionStepPx*3, baseY1)
          }
        };

        // Ø¹Ù…ÙˆØ¯ 2 (Ø£Ø³Ø¦Ù„Ø© 11-20): Ù†ÙØ³ Ø§Ù„ØµÙØŒ Ù…Ø¹ Ø¥Ø²Ø§Ø­Ø© Ø£ÙÙ‚ÙŠØ© Ù„Ù„Ø¹Ù…ÙˆØ¯
        const baseX2 = baseX1 + columnOffsetPx;
        const baseY2 = baseY1;
        const qNum2 = 11 + row;

        questionCoordinates[qNum2] = {
          base: toNorm(baseX2, baseY2),
          options: {
            'Ø£': toNorm(baseX2, baseY2),
            'Ø¨': toNorm(baseX2 - optionStepPx, baseY2),
            'Ø¬': toNorm(baseX2 - optionStepPx*2, baseY2),
            'Ø¯': toNorm(baseX2 - optionStepPx*3, baseY2)
          }
        };
      }

      saveCalibrationSettings();
      alert('ØªÙ… Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø´Ø¨ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©.');
      showDebugInfo('Ø­ÙÙØ¸Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ.');
    }

    function toNorm(x,y){ return { x: x/canvas.width, y: y/canvas.height }; }

    function loadCalibrationSettings(){
      const saved = localStorage.getItem('calibrationSettings');
      if (saved){
        questionCoordinates = JSON.parse(saved);
        showDebugInfo('ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.');
      } else {
        initializeDefaultCoordinates(); // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¬ÙŠØ¯ ÙƒØ¨Ø¯Ø§ÙŠØ©
      }
    }

    function saveCalibrationSettings(){
      localStorage.setItem('calibrationSettings', JSON.stringify(questionCoordinates));
    }

    function initializeDefaultCoordinates(){
      // Ø§ÙØªØ±Ø§Ø¶ ØªØ®Ø·ÙŠØ· Ø´Ø§Ø¦Ø¹ Ø¥Ø°Ø§ Ù„Ù… ØªØªÙ… Ø§Ù„Ù…Ø¹Ø§ÙŠØ±Ø©
      // Ù†Ù‚Ø· Ø£Ø³Ø§Ø³: ÙŠ (15%)ØŒ Ø³1 Ø¹Ù…ÙˆØ¯1 Ø¹Ù†Ø¯ xâ‰ˆ80%, Ø¹Ù…ÙˆØ¯2 Ø¹Ù†Ø¯ xâ‰ˆ45%
      questionCoordinates = {};
      const startY = 0.18, rowStep = 0.06;
      const col1X_A = 0.82, col2X_A = 0.47;
      const optionStep = 0.045; // Ù†Ø³Ø¨ÙŠ Ø£ÙÙ‚ÙŠ
      for (let i=1;i<=10;i++){
        const y = startY + (i-1)*rowStep;
        questionCoordinates[i] = {
          base: {x:col1X_A,y},
          options: {
            'Ø£': {x:col1X_A, y},
            'Ø¨': {x:col1X_A - optionStep, y},
            'Ø¬': {x:col1X_A - optionStep*2, y},
            'Ø¯': {x:col1X_A - optionStep*3, y}
          }
        };
      }
      for (let i=11;i<=20;i++){
        const row=i-10; const y = startY + (row-1)*rowStep;
        questionCoordinates[i] = {
          base: {x:col2X_A,y},
          options: {
            'Ø£': {x:col2X_A, y},
            'Ø¨': {x:col2X_A - optionStep, y},
            'Ø¬': {x:col2X_A - optionStep*2, y},
            'Ø¯': {x:col2X_A - optionStep*3, y}
          }
        };
      }
    }

    // ========= Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª =========
    function updateDetectionSettings(){
      detectionSettings.brightnessThreshold = parseInt(document.getElementById('brightnessThreshold').value);
      detectionSettings.detectionRadius = parseInt(document.getElementById('detectionRadius').value);
      detectionSettings.contrastFactor = parseFloat(document.getElementById('contrastThreshold').value);
      detectionSettings.edgeSensitivity = parseInt(document.getElementById('edgeSensitivity').value);
      document.getElementById('brightnessValue').textContent = detectionSettings.brightnessThreshold;
      document.getElementById('radiusValue').textContent = detectionSettings.detectionRadius+'px';
      document.getElementById('contrastValue').textContent = detectionSettings.contrastFactor.toFixed(1);
      document.getElementById('edgeValue').textContent = detectionSettings.edgeSensitivity;
      showDebugInfo('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒØ´Ù.');
    }

    // ========= Ø§Ù„Ù…Ø³Ø­ =========
    function scanAnswers(){
      if (!processedImage){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      showLoading(true);
      showDebugInfo('Ø¨Ø¯Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª...');
      setTimeout(()=>{
        try{
          const { answers, confidences, rawScores } = detectAllAnswers();
          displayResults({ answers, confidences, rawScores });
          showDebugInfo('ØªÙ… Ø§Ù„Ù…Ø³Ø­ Ø¨Ù†Ø¬Ø§Ø­.');
        }catch(err){
          showDebugInfo('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­: '+err.message);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: '+err.message);
        }
        showLoading(false);
      }, 150);
    }

    function detectAllAnswers(){
      const answers = {};
      const confidences = {};
      const rawScores = {}; // Ù†Ø³Ø¨ Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ù„ÙƒÙ„ Ø®ÙŠØ§Ø±
      const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
      const data = imageData.data;
      let testHtml = '<div class="test-title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙƒØ´Ù Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„:</div>';

      for (let q=1;q<=20;q++){
        const coords = questionCoordinates[q];
        if (!coords){ answers[q]=null; confidences[q]=0; continue; }

        const result = detectSingleAnswer(q, coords, data);
        answers[q] = result.answer;
        confidences[q] = result.confidence;
        rawScores[q] = result.optionScores;

        testHtml += `
          <div class="test-row">
            <span class="test-question">Ø³ ${q}:</span>
            <span class="test-value">${result.answer || 'ÙØ§Ø±Øº/ØºÙŠØ± ÙˆØ§Ø¶Ø­'} (Ø«Ù‚Ø©: ${Math.round(result.confidence*100)}%)</span>
          </div>
        `;

        // Ø±Ø³Ù… Ù†Ù‚Ø·Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
        if (result.detectedAt){
          drawDetectionPoint(q, result.detectedAt.x, result.detectedAt.y, result.answer);
        }
      }

      document.getElementById('testResults').innerHTML = testHtml;
      return { answers, confidences, rawScores };
    }

    function detectSingleAnswer(qNum, coords, data){
      // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±Ø§Ù†
      const optPoints = {};
      for (const [opt, p] of Object.entries(coords.options)){
        const {x, y} = rotateNormPoint(p.x, p.y);
        optPoints[opt] = { x: Math.round(x*canvas.width), y: Math.round(y*canvas.height) };
      }

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ù„ÙƒÙ„ Ø®ÙŠØ§Ø± (ÙƒÙ„Ù…Ø§ ÙƒØ§Ù† Ù…ØªÙˆØ³Ø· Ø§Ù„Ø³Ø·ÙˆØ¹ Ø£Ù‚Ù„ ÙƒØ§Ù† Ø§Ù„ØªØ¸Ù„ÙŠÙ„ Ø£ÙƒØ¨Ø±)
      const scores = {};
      for (const [opt, pt] of Object.entries(optPoints)){
        const darkness = 255 - calculateAreaBrightness(pt.x, pt.y, detectionSettings.detectionRadius, data);
        // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ù†Ø³Ø¨Ø© 0..1
        scores[opt] = Math.max(0, Math.min(1, darkness/255));
      }

      // Ø§Ø®ØªÙØ± Ø§Ù„Ø£Ø¹Ù„Ù‰ ØªØ¸Ù„ÙŠÙ„Ø§Ù‹
      let bestOpt = null, bestScore = -1;
      for (const [opt, s] of Object.entries(scores)){
        if (s > bestScore){ bestScore = s; bestOpt = opt; }
      }

      // Ø§Ù„Ø«Ù‚Ø© = Ø¯Ø±Ø¬Ø© Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ø£ÙØ¶Ù„
      let confidence = bestScore;

      // Ø§Ø¹ØªØ¨Ø§Ø±Ø§Øª: Ø¹ØªØ¨Ø© Ø§Ù„Ø³Ø·ÙˆØ¹ ÙˆØªØ¹Ø¯Ø¯ Ø§Ù„ØªØ¸Ù„ÙŠÙ„
      const sorted = Object.entries(scores).sort((a,b)=>b[1]-a[1]); // [ [opt,score], ... ]
      const top = sorted[0][1], second = sorted[1][1];

      // Ø¥Ø°Ø§ Ø§Ù„ÙØ§Ø±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø£ÙˆÙ„ ÙˆØ§Ù„Ø«Ø§Ù†ÙŠ ØµØºÙŠØ± â†’ ØºÙŠØ± ÙˆØ§Ø¶Ø­
      const ambiguous = (top - second) < detectionSettings.multiMarkTolerance;

      // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¯Ø±Ø¬Ø© Ø£Ù‚Ù„ Ù…Ù† Ø­Ø¯ Ø§Ù„Ù‚Ø¨ÙˆÙ„ â†’ ÙØ§Ø±Øº/ØºÙŠØ± ÙˆØ§Ø¶Ø­
      if (confidence < detectionSettings.minConfidence || ambiguous){
        bestOpt = null;
        confidence = ambiguous ? Math.max(0.15, top) : 0;
      }

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯Øª
      if (manualCorrections[qNum] !== undefined){
        bestOpt = manualCorrections[qNum];
        confidence = 1.0;
      }

      // Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø³Ù…: Ù…Ø±ÙƒØ² Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø®ØªØ§Ø± Ø£Ùˆ Ù…Ø±ÙƒØ² "Ø£" Ø¥Ù† Ù„Ù… ÙŠÙˆØ¬Ø¯
      const drawPt = bestOpt ? optPoints[bestOpt] : optPoints['Ø£'];

      return { answer: bestOpt, confidence, detectedAt: drawPt, optionScores: scores };
    }

    function calculateAreaBrightness(cx, cy, r, data){
      let total = 0, count = 0;
      const w = canvas.width, h = canvas.height;
      for (let y=cy-r; y<=cy+r; y++){
        if (y<0 || y>=h) continue;
        for (let x=cx-r; x<=cx+r; x++){
          if (x<0 || x>=w) continue;
          const dist = (x-cx)*(x-cx) + (y-cy)*(y-cy);
          if (dist <= r*r){
            const idx = (y*w + x)*4;
            const br = (data[idx]+data[idx+1]+data[idx+2])/3;
            total += br; count++;
          }
        }
      }
      return count>0 ? total/count : 255;
    }

    function rotateNormPoint(nx, ny){
      // ÙŠØ¹Ø§Ù„Ø¬ Ø§Ù„Ø¯ÙˆØ±Ø§Ù† 0/90/180/270 Ø¨Ø§Ù„ØªØ¨Ø§Ø¯Ù„
      let x=nx, y=ny;
      switch (currentRotation){
        case 0: return { x, y };
        case 90: return { x: (1 - ny), y: nx };
        case 180: return { x: (1 - nx), y: (1 - ny) };
        case 270: return { x: ny, y: (1 - nx) };
        default: return { x, y };
      }
    }

    function drawDetectionPoint(qNum, x, y, answer){
      const overlay = document.getElementById('canvasOverlay');
      const p = document.createElement('div');
      p.className = 'detection-point';
      p.style.left = x+'px'; p.style.top = y+'px';
      const label = document.createElement('div');
      label.className = 'detection-label';
      label.textContent = `${qNum}:${answer || '?'}`;
      label.style.left = x+'px'; label.style.top = y+'px';
      overlay.appendChild(p); overlay.appendChild(label);
    }

    // ========= Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ =========
    function displayResults(res){
      const { answers, confidences } = res;
      const comparison = compareAnswers(answers, confidences);

      // Ø¥Ø­ØµØ§Ø¡Ø§Øª
      document.getElementById('correctCount').textContent = comparison.correct;
      document.getElementById('wrongCount').textContent = comparison.wrong;
      document.getElementById('emptyCount').textContent = comparison.empty;
      document.getElementById('unclearCount').textContent = comparison.unclear;

      const totalAnswered = comparison.correct + comparison.wrong;
      const totalQuestions = 20;
      const percentage = totalAnswered>0 ? Math.round((comparison.correct/totalQuestions)*100) : 0;
      document.getElementById('finalScore').textContent = `${percentage}%`;
      document.getElementById('progressFill').style.width = `${percentage}%`;

      const detailsHtml = comparison.details.map(d=>{
        let cls='detail-item', status='';
        if (d.isCorrect){ cls+=' correct'; status='âœ“ ØµØ­ÙŠØ­'; }
        else if (d.isEmpty){ cls+=' empty'; status='â—‹ ÙØ§Ø±Øº'; }
        else if (d.isUnclear){ cls+=' unclear'; status='ØŸ ØºÙŠØ± ÙˆØ§Ø¶Ø­'; }
        else { cls+=' wrong'; status='âœ— Ø®Ø·Ø£'; }
        return `
          <div class="${cls}">
            Ø§Ù„Ø³Ø¤Ø§Ù„ ${d.question}: <strong>${d.scanned || 'â€”'}</strong>
            <span style="float:left;">${status} (${Math.round(d.confidence*100)}%)</span>
            ${(!d.isCorrect && !d.isEmpty && !d.isUnclear) ? ` (Ø§Ù„ØµØ­ÙŠØ­: ${d.correct})` : ''}
          </div>
        `;
      }).join('');
      document.getElementById('resultsDetails').innerHTML = detailsHtml;

      // ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª
      updateAnswerKeyDisplay(comparison);

      alert(`ØªÙ… Ø§Ù„Ù…Ø³Ø­.\nØ§Ù„ØµØ­ÙŠØ­Ø©: ${comparison.correct}\nØ§Ù„Ø®Ø§Ø·Ø¦Ø©: ${comparison.wrong}\nØ§Ù„ÙØ§Ø±ØºØ©: ${comparison.empty}\nØºÙŠØ± Ø§Ù„ÙˆØ§Ø¶Ø­Ø©: ${comparison.unclear}\nØ§Ù„Ù†Ø³Ø¨Ø©: ${percentage}%`);
    }

    function compareAnswers(scannedAnswers, confidences){
      const res = { correct:0, wrong:0, empty:0, unclear:0, details:[] };
      for (let i=1;i<=20;i++){
        const scanned = scannedAnswers[i];
        const correct = correctAnswers[i];
        const conf = confidences[i] || 0;

        if (!scanned){
          // Ø§Ø¹ØªØ¨Ø± ØºÙŠØ± ÙˆØ§Ø¶Ø­ Ø¥Ø°Ø§ Ù„Ø¯ÙŠÙ†Ø§ Ø«Ù‚Ø© >0 Ù„ÙƒÙ†Ù‡Ø§ ØªØ­Øª Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰
          if (conf>0 && conf<detectionSettings.minConfidence){
            res.unclear++;
            res.details.push({ question:i, scanned:null, correct, isCorrect:false, isEmpty:false, isUnclear:true, confidence:conf });
          } else {
            res.empty++;
            res.details.push({ question:i, scanned:null, correct, isCorrect:false, isEmpty:true, isUnclear:false, confidence:0 });
          }
        } else if (scanned === correct){
          res.correct++;
          res.details.push({ question:i, scanned, correct, isCorrect:true, isEmpty:false, isUnclear:false, confidence:conf });
        } else {
          res.wrong++;
          res.details.push({ question:i, scanned, correct, isCorrect:false, isEmpty:false, isUnclear:false, confidence:conf });
        }
      }
      return res;
    }

    // ========= Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙŠØ¯ÙˆÙŠ =========
    function toggleManualCorrection(){
      isManualCorrection = !isManualCorrection;
      const panel = document.getElementById('manualCorrection');
      if (isManualCorrection){
        panel.classList.remove('hidden');
        document.getElementById('manualCorrectionBtn').textContent = 'âœï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØµØ­ÙŠØ­';
        generateCorrectionList();
        showDebugInfo('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
      } else {
        panel.classList.add('hidden');
        document.getElementById('manualCorrectionBtn').textContent = 'âœï¸ ØªØµØ­ÙŠØ­ ÙŠØ¯ÙˆÙŠ';
        showDebugInfo('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØµØ­ÙŠØ­ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
      }
    }

    function generateCorrectionList(){
      const container = document.getElementById('correctionList');
      container.innerHTML='';
      for (let i=1;i<=20;i++){
        const div = document.createElement('div');
        div.className='correction-item';
        div.innerHTML = `
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:8px;">
            <span style="font-weight:bold;">Ø³Ø¤Ø§Ù„ ${i}:</span>
            <select class="correction-select" data-question="${i}" style="padding:5px; border-radius:4px; border:1px solid #ddd;">
              <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© --</option>
              <option value="Ø£">Ø£</option>
              <option value="Ø¨">Ø¨</option>
              <option value="Ø¬">Ø¬</option>
              <option value="Ø¯">Ø¯</option>
              <option value="empty">ÙØ§Ø±Øº</option>
            </select>
            <span style="color:#666; font-size:0.9em;">(Ø§Ù„Ù†Ù…ÙˆØ°Ø¬: ${correctAnswers[i] || 'â€”'})</span>
          </div>
        `;
        container.appendChild(div);
      }
    }

    function saveManualCorrections(){
      const selects = document.querySelectorAll('.correction-select');
      let changed = false;
      manualCorrections = {};
      selects.forEach(sel=>{
        const q = parseInt(sel.dataset.question);
        const v = sel.value;
        if (v && v!=='empty'){ manualCorrections[q]=v; changed=true; }
        else if (v==='empty'){ manualCorrections[q]=null; changed=true; }
      });
      if (changed){
        localStorage.setItem('manualCorrections', JSON.stringify(manualCorrections));
        alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØµØ­ÙŠØ­Ø§Øª Ø§Ù„ÙŠØ¯ÙˆÙŠØ©.');
        toggleManualCorrection();
        if (processedImage) setTimeout(scanAnswers, 300);
      } else {
        alert('Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØºÙŠÙŠØ±Ø§Øª Ù„Ù„Ø­ÙØ¸.');
      }
    }

    function cancelManualCorrections(){
      toggleManualCorrection();
    }

    // ========= Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„Ø¯ÙˆØ±Ø§Ù† =========
    function drawImageWithRotation(){
      if (!originalImage) return;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.save();
      ctx.translate(canvas.width/2, canvas.height/2);
      ctx.rotate(currentRotation * Math.PI/180);

      let dw, dh;
      if (currentRotation===90 || currentRotation===270){ dw=originalImage.height; dh=originalImage.width; }
      else { dw=originalImage.width; dh=originalImage.height; }

      const scale = Math.min(canvas.width/dw, canvas.height/dh);
      ctx.scale(scale, scale);
      ctx.drawImage(originalImage, -dw/2, -dh/2);
      ctx.restore();
      processedImage = ctx.getImageData(0,0,canvas.width,canvas.height);
      // Ø§Ù…Ø³Ø­ Ø·Ø¨Ù‚Ø© Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª
      document.getElementById('canvasOverlay').innerHTML='';
    }

    function rotateImage(deg){
      if (!originalImage){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      currentRotation = (currentRotation + deg + 360) % 360;
      // ØªØ¨Ø§Ø¯Ù„ Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯ Ø¹Ù†Ø¯ 90/270
      if (Math.abs(deg)%180===90){
        const tmp = canvas.width; canvas.width = canvas.height; canvas.height = tmp;
      }
      drawImageWithRotation();
      updateOrientationIndicator();
    }

    function autoRotateImage(){
      if (!originalImage){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø±ÙØ¹ ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹'); return; }
      showLoading(true);
      setTimeout(()=>{
        const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
        const br = analyzeImageBrightness(imageData);
        // Ù‚ÙˆØ§Ø¹Ø¯ Ø¨Ø³ÙŠØ·Ø©: Ø¥Ø°Ø§ Ø£Ø³ÙÙ„ Ø£ØºÙ…Ù‚ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø£Ø¹Ù„Ù‰ â†’ Ø±Ø¨Ù…Ø§ Ù…Ù‚Ù„ÙˆØ¨Ø©
        if (br.top < br.bottom * 0.8){
          rotateImage(180);
          alert('ØªÙ… ØªØ¯ÙˆÙŠØ± Ø§Ù„ØµÙˆØ±Ø© 180Â° ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
        } else if (br.left < br.right * 0.8){
          rotateImage(90);
          alert('ØªÙ… ØªØ¯ÙˆÙŠØ± Ø§Ù„ØµÙˆØ±Ø© 90Â° ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
        } else {
          alert('Ø§Ù„Ø§ØªØ¬Ø§Ù‡ ÙŠØ¨Ø¯Ùˆ ØµØ­ÙŠØ­Ø§Ù‹.');
        }
        showLoading(false);
      }, 250);
    }

    function analyzeImageBrightness(imageData){
      const data = imageData.data, w=imageData.width, h=imageData.height;
      let top=0,bottom=0,left=0,right=0, tc=0,bc=0,lc=0,rc=0;
      for (let y=0;y<h;y++){
        for (let x=0;x<w;x++){
          const idx=(y*w+x)*4; const b=(data[idx]+data[idx+1]+data[idx+2])/3;
          if (y<h/2){ top+=b; tc++; } else { bottom+=b; bc++; }
          if (x<w/2){ left+=b; lc++; } else { right+=b; rc++; }
        }
      }
      return { top: top/tc, bottom: bottom/bc, left: left/lc, right: right/rc };
    }

    function updateOrientationIndicator(){
      const o = document.getElementById('orientationIndicator');
      let t='Ø§Ù„Ø§ØªØ¬Ø§Ù‡: ';
      if (currentRotation===0) t+='Ø·Ø¨ÙŠØ¹ÙŠ';
      else if (currentRotation===90) t+='90Â° ÙŠÙ…ÙŠÙ†';
      else if (currentRotation===180) t+='Ù…Ù‚Ù„ÙˆØ¨';
      else if (currentRotation===270) t+='90Â° ÙŠØ³Ø§Ø±';
      o.textContent = t;
    }

    function showLoading(show){ document.getElementById('loading').classList.toggle('hidden', !show); isProcessing = show; }
    function showDebugInfo(msg){
      const dbg = document.getElementById('debugPanel');
      const content = document.getElementById('debugContent');
      dbg.classList.remove('hidden');
      const ts = new Date().toLocaleTimeString();
      content.innerHTML = `[${ts}] ${msg}<br/>` + content.innerHTML;
    }
    function toggleDebugPanel(){
      const dbg = document.getElementById('debugPanel');
      const btn = document.getElementById('toggleDebug');
      if (dbg.classList.contains('hidden')){ dbg.classList.remove('hidden'); btn.textContent='Ø¥Ø®ÙØ§Ø¡'; }
      else { dbg.classList.add('hidden'); btn.textContent='Ø¥Ø¸Ù‡Ø§Ø±'; }
    }

    function resetApp(){
      originalImage=null; processedImage=null; currentRotation=0;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      document.getElementById('finalScore').textContent='0%';
      document.getElementById('progressFill').style.width='0%';
      document.getElementById('resultsDetails').innerHTML='';
      document.getElementById('testResults').innerHTML='';
      ['correctCount','wrongCount','emptyCount','unclearCount'].forEach(id=>document.getElementById(id).textContent='0');
      document.getElementById('canvasOverlay').innerHTML='';
      if (calibrationMode) toggleCalibrationMode();
      if (isManualCorrection) toggleManualCorrection();
      updateOrientationIndicator();
      showDebugInfo('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.');
    }

    // ========= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ© =========
    function generateAnswerKeyDisplay(){
      const container = document.getElementById('answerKey');
      container.innerHTML='';
      for (let i=1;i<=20;i++){
        const ans = correctAnswers[i];
        const div = document.createElement('div');
        div.className='question-item';
        div.id=`question-${i}`;
        div.innerHTML = `
          <div class="question-number">${i}</div>
          <div class="question-answer">${ans || '?'}</div>
        `;
        container.appendChild(div);
      }
    }

    function updateAnswerKeyDisplay(results){
      for (let i=1;i<=20;i++){
        const div = document.getElementById(`question-${i}`);
        if (!div) continue;
        div.classList.remove('correct','wrong','empty','unclear');
        const det = results.details.find(d=>d.question===i);
        if (!det) continue;
        if (det.isCorrect) div.classList.add('correct');
        else if (det.isEmpty) div.classList.add('empty');
        else if (det.isUnclear) div.classList.add('unclear');
        else div.classList.add('wrong');
      }
    }

    function openEditModal(){
      document.getElementById('editModal').classList.remove('hidden');
      populateEditGrid();
    }
    function closeEditModal(){ document.getElementById('editModal').classList.add('hidden'); }

    function populateEditGrid(){
      const container = document.getElementById('editGrid');
      container.innerHTML='';
      const answersText = Array.from({length:20},(_,i)=> correctAnswers[i+1] || '').join('\n');
      document.getElementById('bulkEditTextarea').value = answersText;

      for (let i=1;i<=20;i++){
        const ans = correctAnswers[i] || '';
        const editDiv = document.createElement('div');
        editDiv.className='edit-question';
        editDiv.dataset.question = i;
        const optionsHtml = ['Ø£','Ø¨','Ø¬','Ø¯'].map(o=>`
          <div class="answer-option ${ans===o?'selected':''}" data-option="${o}">${o}</div>
        `).join('');
        editDiv.innerHTML = `
          <div class="edit-question-number">Ø³Ø¤Ø§Ù„ ${i}</div>
          <div class="answer-options">${optionsHtml}</div>
        `;
        editDiv.querySelectorAll('.answer-option').forEach(opt=>{
          opt.addEventListener('click', e=>{
            const q = parseInt(editDiv.dataset.question);
            const sel = e.target.dataset.option;
            selectAnswer(q, sel);
          });
        });
        container.appendChild(editDiv);
      }
    }

    function selectAnswer(questionNum, answer){
      correctAnswers[questionNum] = answer;
      const editDiv = document.querySelector(`.edit-question[data-question="${questionNum}"]`);
      if (editDiv){
        editDiv.querySelectorAll('.answer-option').forEach(o=>{
          o.classList.remove('selected');
          if (o.dataset.option===answer) o.classList.add('selected');
        });
      }
      const mainDiv = document.getElementById(`question-${questionNum}`);
      if (mainDiv) mainDiv.querySelector('.question-answer').textContent = answer || '?';
    }

    function saveEdits(){
      localStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
      alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ÙŠØ©.');
      closeEditModal();
      generateAnswerKeyDisplay();
    }

    function setAllAnswers(answer){ for (let i=1;i<=20;i++) selectAnswer(i, answer); }
    function clearAllAnswers(){ for (let i=1;i<=20;i++) selectAnswer(i, ''); }

    function applyBulkEdit(){
      const lines = document.getElementById('bulkEditTextarea').value.trim().split('\n');
      for (let i=0;i<20 && i<lines.length;i++){
        let a = lines[i].trim();
        // Ø¯Ø¹Ù… A/B/C/D Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
        if (['A','B','C','D'].includes(a.toUpperCase())){
          a = a.toUpperCase()==='A'?'Ø£': a.toUpperCase()==='B'?'Ø¨': a.toUpperCase()==='C'?'Ø¬':'Ø¯';
        }
        if (['Ø£','Ø¨','Ø¬','Ø¯'].includes(a)) selectAnswer(i+1, a);
      }
      alert('ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹.');
    }

  </script>
</body>
</html>